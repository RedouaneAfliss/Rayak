{% extends '::base.html.twig' %}

{% block description %}This is an awesome web site.{% endblock %}

{% block stylesheets %}
{{parent()}}
<link href="{{ asset('jqvmap/jqvmap.css') }}" media="screen" rel="stylesheet" type="text/css" />
{% endblock %}

{% block javascripts %}
{{parent()}}
<script src="{{ asset('highcharts/js/highcharts.js') }}"></script>
<script src="{{ asset('jqvmap/jquery.vmap.js') }}" type="text/javascript"></script>
<script src="{{ asset('jqvmap/maps/jquery.vmap.world.js') }}" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $.ajax({
            type:'GET',
            'url':'{{path('db_main_evolution')}}',
            success:function(data){
                var graphData=new Array();
                var l=data.length;
                for(var i=0;i<l;i++){
                    graphData.push([Date.UTC(data[i].year,data[i].month-1,data[i].day),data[i].count]);
                }
                showEvolution(graphData);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_inventors_country')}}',
            success: function(data) {
                createMap(data);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_keywords')}}',
            success: function(data) {
                showKeywords(data);
            }
        });
    });

    function showEvolution(data) {
        $('#charts').highcharts({
            chart: {
                type: 'spline'
            },
            title: {
                text: 'Evolution du nombre de brevets publiés'
            },
            xAxis: {
                type: 'datetime',
                dateTimeLabelFormats: {// don't display the dummy year
                    month: '%e. %b',
                    year: '%b'
                }
            },
            yAxis: {
                title: {
                    text: 'Nombre de brevets'
                },
                min: 0
            },
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                            Highcharts.dateFormat('%e. %b', this.x) + ': ' + this.y + ' brevets';
                }
            },
            series: [{
                    name: 'Brevets publiés 15/09/2013 - 15/11/2013',
                    data: data
                }]
        });
    }
    function showKeywords(data) {
        l = data.length;
        for (var i = 0; i < l; i++) {
            var keyword = data[i].keyword;
            var count = data[i].count;
            var html = '<div style="float: left;" class="well">' + keyword + ' <span class="badge">' + count + '</span></div>';
            $('#keywords').append(html);
        }
    }
    
    function showInventors(data,countryCode){
        var l = data.length;
        $('#inventors').html('<h4>'+countryCode+'</h4>');
        for(var i=0;i<l;i++){
            $('#inventors').append('<div class="badge">'+data[i].name+'</div>');
        }
    }

    function createMap(data) {
        jQuery('#vmap').vectorMap({
            values: data,
            map: 'world_en',
            backgroundColor: '#a5bfdd',
            borderColor: '#818181',
            borderOpacity: 0.25,
            borderWidth: 1,
            color: '#f4f3f0',
            enableZoom: true,
            hoverColor: '#c9dfaf',
            hoverOpacity: null,
            normalizeFunction: 'linear',
            scaleColors: ['#b6d6ff', '#005ace'],
            selectedColor: '#c9dfaf',
            selectedRegion: null,
            showTooltip: true,
            onRegionClick: function(element, code, region)
            {
                $.ajax({
                    type:'GET',
                    url:'{{ path('db_main_country_inventors') }}?countryCode='+code,
                    success:function(data){
                        if(data.error){
                            alert(data.error);
                        }
                        showInventors(data,code);
                    }
                });
            }
        });
    }
</script>
{% endblock %}

{% block body %}
<h2>Evolution du nombre de brevets publiés</h2>
<div id="charts"></div>
<h2>Les inventeurs répartis sur les pays.</h2>
<div id="vmap" style="width: 800px; height: 600px;"></div>
<div id="inventors"></div>
<h2>Les mots-clé les plus fréquents dans tous les brevets.</h2>
<div id="keywords"></div>
{% endblock %}
